<?php\n/**\n * Muy Únicos - Digital Restriction System\n * \n * Sistema de restricción de contenido digital v2.6.3 (Bugfixes)\n * Propósito: Restringir productos físicos en subdominios, mostrando solo \n * productos digitales. Optimizado para rendimiento y compatibilidad.\n * \n * @package GeneratePress_Child\n * @since 2.6.3\n */\n\nif ( ! defined( 'ABSPATH' ) ) {\n    exit; // Exit if accessed directly\n}\n\nif ( ! defined( 'MUYU_PHYSICAL_FORMAT_ID' ) ) {\n    define( 'MUYU_PHYSICAL_FORMAT_ID', 112 );\n}\nif ( ! defined( 'MUYU_DIGITAL_FORMAT_ID' ) ) {\n    define( 'MUYU_DIGITAL_FORMAT_ID', 111 );\n}\n\nif ( ! class_exists( 'MUYU_Digital_Restriction_System' ) ) {\n\n    /**\n     * Clase Principal - Patrón Singleton\n     */\n    class MUYU_Digital_Restriction_System {\n        \n        private static $instance = null;\n        private $cache = [];\n        \n        const OPTION_PRODUCT_IDS  = 'muyu_digital_product_ids';\n        const OPTION_CATEGORY_IDS = 'muyu_digital_category_ids';\n        const OPTION_TAG_IDS      = 'muyu_digital_tag_ids';\n        const OPTION_REDIRECT_MAP = 'muyu_phys_to_dig_map';\n        const OPTION_LAST_UPDATE  = 'muyu_digital_list_updated';\n        const TRANSIENT_REBUILD   = 'muyu_rebuild_scheduled';\n        \n        public static function get_instance() {\n            if ( null === self::$instance ) {\n                self::$instance = new self();\n            }\n            return self::$instance;\n        }\n        \n        private function __construct() {\n            $this->init_hooks();\n        }\n        \n        private function init_hooks() {\n            // ---- Gestión de índices (Admin) ----\n            \n            // Refactorizado a Endpoint WC-AJAX\n            add_action( 'wc_ajax_mu_rebuild_digital_list', [ $this, 'ajax_rebuild_indexes' ] );\n            \n            add_action( 'woocommerce_update_product', [ $this, 'schedule_rebuild' ], 10, 1 );\n            add_action( 'admin_init', [ $this, 'ensure_indexes_exist' ], 5 );\n            add_action( 'admin_enqueue_scripts', [ $this, 'enqueue_admin_assets' ] );\n            add_action( 'shutdown', [ $this, 'execute_scheduled_rebuild' ] );\n            \n            // ---- Filtrado de contenido (Frontend) ----\n            add_action( 'pre_get_posts', [ $this, 'filter_product_queries' ], 50 );\n            add_action( 'template_redirect', [ $this, 'handle_redirects' ], 20 );\n            \n            // ---- Filtros de Menús y Taxonomías ----\n            add_filter( 'get_terms_args', [ $this, 'filter_category_terms' ], 10, 2 );\n            add_filter( 'wp_get_nav_menu_items', [ $this, 'filter_menu_items' ], 10, 3 );\n            \n            // ---- Variaciones (Productos variables) ----\n            add_filter( 'woocommerce_variation_is_visible', [ $this, 'hide_physical_variation' ], 10, 4 );\n            add_filter( 'woocommerce_dropdown_variation_attribute_options_args', [ $this, 'clean_variation_dropdown' ], 10, 1 );\n            add_filter( 'woocommerce_variation_prices', [ $this, 'filter_variation_prices' ], 10, 3 );\n            \n            // ---- Auto-selección inteligente de variación ----\n            add_filter( 'woocommerce_product_get_default_attributes', [ $this, 'set_format_default' ], 20, 2 );\n            add_action( 'woocommerce_before_add_to_cart_button', [ $this, 'autoselect_format_variation_bridge' ], 5 );\n        }\n        \n        // =====================================================================\n        // DETECCIÓN DE USUARIOS Y CONTEXTO\n        // =====================================================================\n        \n        public function is_restricted_user() {\n            if ( isset( $this->cache['is_restricted'] ) ) {\n                return $this->cache['is_restricted'];\n            }\n            \n            if ( current_user_can( 'manage_woocommerce' ) || ( is_admin() && ! wp_doing_ajax() ) ) {\n                $this->cache['is_restricted'] = false;\n                return false;\n            }\n            \n            $main_domain = function_exists( 'muyu_get_main_domain' ) ? muyu_get_main_domain() : 'muyunicos.com';\n            $host = preg_replace( '/:\\d+$/', '', trim( $_SERVER['HTTP_HOST'] ?? '' ) );\n            $host = str_replace( 'www.', '', $host );\n            \n            // Bypass en desarrollo local para evitar bloqueos masivos y falsos positivos\n            if ( strpos( $host, '.local' ) !== false || 'localhost' === $host ) {\n                $this->cache['is_restricted'] = false;\n                return false;\n            }\n            \n            $this->cache['is_restricted'] = ( $main_domain !== $host );\n            return $this->cache['is_restricted'];\n        }\n        \n        public function get_user_country_code() {\n            if ( isset( $this->cache['country_code'] ) ) {\n                return $this->cache['country_code'];\n            }\n            \n            if ( function_exists( 'muyu_get_current_country_from_subdomain' ) ) {\n                $code = muyu_get_current_country_from_subdomain();\n            } else {\n                $host = preg_replace( '/:\\d+$/', '', trim( $_SERVER['HTTP_HOST'] ?? '' ) );\n                $parts = explode( '.', $host );\n                if ( count( $parts ) >= 3 ) {\n                    $subdomain = strtolower( $parts[0] );\n                    $subdomain_map = [\n                        'mexico' => 'MX', 'br' => 'BR', 'co' => 'CO', 'ec' => 'EC',\n                        'cl' => 'CL', 'pe' => 'PE', 'ar' => 'AR'\n                    ];\n                    $code = $subdomain_map[ $subdomain ] ?? ( 2 === strlen( $subdomain ) ? strtoupper( $subdomain ) : 'AR' );\n                } else {\n                    $code = 'AR';\n                }\n            }\n            \n            $this->cache['country_code'] = $code;\n            return $code;\n        }\n\n        // =====================================================================\n        // GESTIÓN DE ÍNDICES (REBUILD OPTIMIZADO)\n        // =====================================================================\n        \n        public function rebuild_digital_indexes() {\n            $digital_product_ids = $this->get_digital_product_ids();\n            \n            if ( empty( $digital_product_ids ) ) {\n                $this->save_empty_indexes();\n                return 0;\n            }\n            \n            list( $category_ids, $tag_ids ) = $this->get_product_terms( $digital_product_ids );\n            $category_ids = $this->expand_category_hierarchy( $category_ids );\n            $redirect_map = $this->build_redirect_map( $digital_product_ids );\n            \n            $this->save_indexes( $digital_product_ids, $category_ids, $tag_ids, $redirect_map );\n            return count( $digital_product_ids );\n        }\n        \n        private function get_digital_product_ids() {\n            global $wpdb;\n            $sql = \"\n                SELECT DISTINCT p.ID as product_id\n                FROM {$wpdb->posts} p\n                INNER JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id\n                WHERE p.post_type = 'product' \n                AND p.post_status = 'publish'\n                AND pm.meta_key IN ('_virtual', '_downloadable')\n                AND pm.meta_value = 'yes'\n                \n                UNION\n                \n                SELECT DISTINCT p.post_parent as product_id\n                FROM {$wpdb->posts} p\n                INNER JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id\n                WHERE p.post_type = 'product_variation' \n                AND p.post_status = 'publish'\n                AND pm.meta_key IN ('_virtual', '_downloadable')\n                AND pm.meta_value = 'yes'\n                AND p.post_parent > 0\n            \";\n            \n            $ids = $wpdb->get_col( $sql );\n            return array_filter( array_unique( array_map( 'intval', $ids ) ) );\n        }\n        \n        private function get_product_terms( $product_ids ) {\n            global $wpdb;\n            $ids_string = implode( ',', array_map( 'intval', $product_ids ) );\n            if ( empty( $ids_string ) ) return [ [], [] ];\n\n            $sql = \"\n                SELECT DISTINCT t.term_id, tt.taxonomy \n                FROM {$wpdb->terms} t\n                INNER JOIN {$wpdb->term_taxonomy} tt ON t.term_id = tt.term_id\n                INNER JOIN {$wpdb->term_relationships} tr ON tt.term_taxonomy_id = tr.term_taxonomy_id\n                WHERE tr.object_id IN ($ids_string)\n                AND tt.taxonomy IN ('product_cat', 'product_tag')\n            \";\n            \n            $terms = $wpdb->get_results( $sql );\n            $category_ids = [];\n            $tag_ids = [];\n            \n            foreach ( $terms as $term ) {\n                if ( 'product_cat' === $term->taxonomy ) {\n                    $category_ids[] = (int) $term->term_id;\n                } elseif ( 'product_tag' === $term->taxonomy ) {\n                    $tag_ids[] = (int) $term->term_id;\n                }\n            }\n            \n            return [ array_unique( $category_ids ), array_unique( $tag_ids ) ];\n        }\n        \n        private function expand_category_hierarchy( $category_ids ) {\n            $expanded = $category_ids;\n            foreach ( $category_ids as $cat_id ) {\n                $ancestors = get_ancestors( $cat_id, 'product_cat', 'taxonomy' );\n                if ( ! empty( $ancestors ) ) {\n                    $expanded = array_merge( $expanded, $ancestors );\n                }\n            }\n            return array_unique( array_map( 'intval', $expanded ) );\n        }\n        \n        private function build_redirect_map( $digital_product_ids ) {\n            global $wpdb;\n            if ( empty( $digital_product_ids ) ) return [];\n            \n            $ids_string = implode( ',', array_map( 'intval', $digital_product_ids ) );\n            $sql = \"SELECT ID, post_name FROM {$wpdb->posts} WHERE ID IN ($ids_string)\";\n            $digital_products = $wpdb->get_results( $sql );\n            \n            $redirect_map = [];\n            foreach ( $digital_products as $product ) {\n                if ( false !== strpos( $product->post_name, '-imprimible' ) ) {\n                    $base_slug = str_replace( '-imprimible', '', $product->post_name );\n                    $physical_id = $wpdb->get_var( \n                        $wpdb->prepare(\n                            \"SELECT ID FROM {$wpdb->posts} \n                            WHERE post_name = %s \n                            AND post_type = 'product' \n                            AND post_status = 'publish' \n                            LIMIT 1\",\n                            $base_slug\n                        )\n                    );\n                    \n                    if ( $physical_id && ! in_array( (int) $physical_id, $digital_product_ids, true ) ) {\n                        $redirect_map[ (int) $physical_id ] = (int) $product->ID;\n                    }\n                }\n            }\n            return $redirect_map;\n        }\n        \n        private function save_indexes( $product_ids, $category_ids, $tag_ids, $redirect_map ) {\n            update_option( self::OPTION_PRODUCT_IDS, $product_ids, false );\n            update_option( self::OPTION_CATEGORY_IDS, $category_ids, false );\n            update_option( self::OPTION_TAG_IDS, $tag_ids, false );\n            update_option( self::OPTION_REDIRECT_MAP, $redirect_map, false );\n            update_option( self::OPTION_LAST_UPDATE, current_time( 'mysql' ), false );\n            delete_transient( self::TRANSIENT_REBUILD );\n        }\n        \n        private function save_empty_indexes() {\n            update_option( self::OPTION_PRODUCT_IDS, [], false );\n            update_option( self::OPTION_CATEGORY_IDS, [], false );\n            update_option( self::OPTION_TAG_IDS, [], false );\n            update_option( self::OPTION_REDIRECT_MAP, [], false );\n            update_option( self::OPTION_LAST_UPDATE, current_time( 'mysql' ), false );\n        }\n\n        // =====================================================================\n        // HANDLERS DE EVENTOS Y ADMIN UI\n        // =====================================================================\n        \n        public function ajax_rebuild_indexes() {\n            check_ajax_referer( 'muyu-rebuild-nonce', 'nonce' );\n            if ( ! current_user_can( 'manage_woocommerce' ) ) {\n                wp_send_json_error( 'Permisos insuficientes' );\n            }\n            \n            $count = $this->rebuild_digital_indexes();\n            wp_send_json_success( sprintf( 'Índice reconstruido correctamente. Total productos digitales: %d', $count ) );\n        }\n        \n        public function schedule_rebuild( $product_id ) {\n            if ( ! get_transient( self::TRANSIENT_REBUILD ) ) {\n                set_transient( self::TRANSIENT_REBUILD, true, 120 );\n            }\n        }\n        \n        public function execute_scheduled_rebuild() {\n            if ( get_transient( self::TRANSIENT_REBUILD ) ) {\n                $this->rebuild_digital_indexes();\n            }\n        }\n        \n        public function ensure_indexes_exist() {\n            if ( false === get_option( self::OPTION_PRODUCT_IDS ) ) {\n                $this->rebuild_digital_indexes();\n            }\n        }\n        \n        public function enqueue_admin_assets( $hook ) {\n            // FIX 1: Utilizar hook explícito y _GET en vez del inestable global $typenow\n            if ( 'edit.php' !== $hook ) return;\n            $post_type = isset( $_GET['post_type'] ) ? $_GET['post_type'] : '';\n            if ( 'product' !== $post_type ) return;\n\n            $theme_uri = get_stylesheet_directory_uri();\n            $ver       = wp_get_theme()->get( 'Version' );\n\n            wp_enqueue_style( 'mu-admin', $theme_uri . '/css/admin.css', [], $ver );\n            wp_enqueue_script( 'mu-admin-js', $theme_uri . '/js/admin.js', [], $ver, true );\n            wp_localize_script( 'mu-admin-js', 'muyuAdminData', [\n                'nonce'       => wp_create_nonce( 'muyu-rebuild-nonce' ),\n                'label'       => '⚡ Reindexar Digitales',\n                'wc_ajax_url' => \\WC_AJAX::get_endpoint( 'mu_rebuild_digital_list' )\n            ] );\n        }\n\n        // =====================================================================\n        // FILTRADO DE QUERIES (PRE_GET_POSTS)\n        // =====================================================================\n        \n        public function filter_product_queries( $query ) {\n            if ( is_admin() || ! $query->is_main_query() ) return;\n            if ( $query->is_product() || ( $query->is_singular() && 'product' === $query->get( 'post_type' ) ) ) return;\n            \n            $is_shop_query = (\n                ( function_exists( 'is_shop' ) && is_shop() ) ||\n                ( function_exists( 'is_product_category' ) && is_product_category() ) ||\n                ( function_exists( 'is_product_tag' ) && is_product_tag() ) ||\n                is_search() ||\n                'product' === $query->get( 'post_type' )\n            );\n            \n            if ( ! $is_shop_query ) return;\n            \n            if ( $this->is_restricted_user() ) {\n                $digital_ids = get_option( self::OPTION_PRODUCT_IDS, [] );\n                $digital_ids = array_map( 'intval', (array) $digital_ids );\n                \n                // FIX 2: Fallback si está vacío. Evita romper la query si aún no se reindexó\n                if ( empty( $digital_ids ) ) return;\n                \n                $query->set( 'post__in', $digital_ids );\n            }\n        }\n\n        // =====================================================================\n        // FILTROS FRONTEND (MENÚS Y TAXONOMÍAS)\n        // =====================================================================\n        \n        public function filter_category_terms( $args, $taxonomies ) {\n            if ( is_admin() || wp_is_json_request() ) return $args;\n            if ( ! in_array( 'product_cat', (array) $taxonomies, true ) || ! $this->is_restricted_user() ) return $args;\n            \n            $digital_cat_ids = get_option( self::OPTION_CATEGORY_IDS, [] );\n            $digital_cat_ids = array_map( 'intval', (array) $digital_cat_ids );\n            \n            // FIX 3: Fallback si está vacío, mostrar todas en vez de [0] para no desaparecer la UI\n            if ( empty( $digital_cat_ids ) ) return $args;\n            \n            if ( ! empty( $args['include'] ) ) {\n                $current = array_map( 'intval', is_array( $args['include'] ) ? $args['include'] : explode( ',', $args['include'] ) );\n                $intersect = array_intersect( $current, $digital_cat_ids );\n                $args['include'] = empty( $intersect ) ? [ 0 ] : $intersect;\n            } else {\n                $args['include'] = $digital_cat_ids;\n            }\n            \n            return $args;\n        }\n        \n        public function filter_menu_items( $items, $menu, $args ) {\n            if ( is_admin() || wp_is_json_request() || ! $this->is_restricted_user() ) return $items;\n            \n            $digital_cat_ids = get_option( self::OPTION_CATEGORY_IDS, [] );\n            $digital_cat_ids = array_map( 'intval', (array) $digital_cat_ids );\n            \n            // FIX 4: Fallback\n            if ( empty( $digital_cat_ids ) ) return $items;\n            \n            return array_filter( $items, function( $item ) use ( $digital_cat_ids ) {\n                if ( isset( $item->object ) && 'product_cat' === $item->object ) {\n                    return in_array( (int) $item->object_id, $digital_cat_ids, true );\n                }\n                return true;\n            });\n        }\n\n        // =====================================================================\n        // REDIRECCIONES (REFACTORIZADO)\n        // =====================================================================\n        \n        public function handle_redirects() {\n            if ( is_admin() || ! $this->is_restricted_user() ) return;\n            if ( ! is_product() && ! is_product_category() && ! is_product_tag() ) return;\n            \n            $target_url = '';\n            $should_redirect = false;\n            \n            if ( is_product_category() ) {\n                list( $should_redirect, $target_url ) = $this->handle_category_redirect();\n            } elseif ( is_product_tag() ) {\n                list( $should_redirect, $target_url ) = $this->handle_tag_redirect();\n            } elseif ( is_product() ) {\n                list( $should_redirect, $target_url ) = $this->handle_product_redirect();\n            }\n            \n            if ( $should_redirect ) {\n                $this->execute_redirect( $target_url );\n            }\n        }\n        \n        private function handle_category_redirect() {\n            $queried_object = get_queried_object();\n            $digital_cats = get_option( self::OPTION_CATEGORY_IDS, [] );\n            $digital_cats = array_map( 'intval', (array) $digital_cats );\n            \n            if ( empty( $digital_cats ) || ! $queried_object || in_array( (int) $queried_object->term_id, $digital_cats, true ) ) {\n                return [ false, '' ];\n            }\n            \n            $parent_id = $queried_object->parent;\n            while ( $parent_id ) {\n                if ( in_array( (int) $parent_id, $digital_cats, true ) ) {\n                    return [ true, get_term_link( $parent_id, 'product_cat' ) ];\n                }\n                $term = get_term( $parent_id, 'product_cat' );\n                $parent_id = ( $term && ! is_wp_error( $term ) ) ? $term->parent : 0;\n            }\n            \n            return [ true, '' ];\n        }\n        \n        private function handle_tag_redirect() {\n            $queried_object = get_queried_object();\n            $digital_tags = get_option( self::OPTION_TAG_IDS, [] );\n            $digital_tags = array_map( 'intval', (array) $digital_tags );\n            \n            if ( empty( $digital_tags ) || ! $queried_object || in_array( (int) $queried_object->term_id, $digital_tags, true ) ) {\n                return [ false, '' ];\n            }\n            \n            return [ true, '' ];\n        }\n        \n        private function handle_product_redirect() {\n            global $post;\n            $digital_ids = get_option( self::OPTION_PRODUCT_IDS, [] );\n            $digital_ids = array_map( 'intval', (array) $digital_ids );\n            \n            if ( empty( $digital_ids ) || ! $post || in_array( (int) $post->ID, $digital_ids, true ) ) {\n                return [ false, '' ];\n            }\n            \n            $redirect_map = get_option( self::OPTION_REDIRECT_MAP, [] );\n            if ( isset( $redirect_map[ $post->ID ] ) ) {\n                return [ true, get_permalink( $redirect_map[ $post->ID ] ) ];\n            }\n            \n            $target_url = $this->find_digital_category_for_product( $post->ID );\n            return [ true, $target_url ];\n        }\n        \n        private function find_digital_category_for_product( $product_id ) {\n            $digital_cats = get_option( self::OPTION_CATEGORY_IDS, [] );\n            $digital_cats = array_map( 'intval', (array) $digital_cats );\n            \n            if ( empty( $digital_cats ) ) return '';\n            \n            $product_cats = wp_get_post_terms( $product_id, 'product_cat', [ 'fields' => 'ids' ] );\n            if ( empty( $product_cats ) || is_wp_error( $product_cats ) ) return '';\n            \n            foreach ( $product_cats as $cat_id ) {\n                if ( in_array( (int) $cat_id, $digital_cats, true ) ) {\n                    return get_term_link( (int) $cat_id, 'product_cat' );\n                }\n            }\n            \n            foreach ( $product_cats as $cat_id ) {\n                $ancestors = get_ancestors( $cat_id, 'product_cat', 'taxonomy' );\n                foreach ( $ancestors as $ancestor_id ) {\n                    if ( in_array( (int) $ancestor_id, $digital_cats, true ) ) {\n                        return get_term_link( (int) $ancestor_id, 'product_cat' );\n                    }\n                }\n            }\n            \n            return '';\n        }\n        \n        private function execute_redirect( $target_url ) {\n            global $post;\n            \n            if ( empty( $target_url ) || is_wp_error( $target_url ) ) {\n                if ( is_product() && isset( $post->post_title ) ) {\n                    $target_url = home_url( '/?s=' . urlencode( $post->post_title ) . '&post_type=product' );\n                } else {\n                    $target_url = wc_get_page_permalink( 'shop' );\n                }\n            }\n            \n            if ( function_exists( 'insertar_prefijo_idioma' ) && function_exists( 'muyu_country_language_prefix' ) ) {\n                $prefix = muyu_country_language_prefix( $this->get_user_country_code() );\n                if ( $prefix ) {\n                    $target_url = insertar_prefijo_idioma( $target_url, $prefix );\n                }\n            }\n            \n            wp_redirect( $target_url, 302 );\n            exit;\n        }\n\n        // =====================================================================\n        // GESTIÓN DE VARIACIONES (pa_formato)\n        // =====================================================================\n        \n        public function hide_physical_variation( $visible, $variation_id, $product_id, $variation ) {\n            if ( ! $visible || ! $this->is_restricted_user() ) return $visible;\n            \n            $attributes = $variation->get_attributes();\n            $physical_term = get_term( MUYU_PHYSICAL_FORMAT_ID, 'pa_formato' );\n            \n            if ( $physical_term && ! is_wp_error( $physical_term ) ) {\n                if ( isset( $attributes['pa_formato'] ) && $attributes['pa_formato'] === $physical_term->slug ) {\n                    return false;\n                }\n            }\n            return $visible;\n        }\n        \n        public function clean_variation_dropdown( $args ) {\n            if ( ! $this->is_restricted_user() || ! isset( $args['attribute'] ) || 'pa_formato' !== $args['attribute'] ) return $args;\n            if ( empty( $args['options'] ) ) return $args;\n            \n            $physical_term = get_term( MUYU_PHYSICAL_FORMAT_ID, 'pa_formato' );\n            if ( ! $physical_term || is_wp_error( $physical_term ) ) return $args;\n            \n            foreach ( $args['options'] as $key => $option ) {\n                if ( ( is_object( $option ) && isset( $option->term_id ) && $option->term_id == MUYU_PHYSICAL_FORMAT_ID ) ||\n                     ( is_string( $option ) && $option === $physical_term->slug ) ) {\n                    unset( $args['options'][ $key ] );\n                }\n            }\n            return $args;\n        }\n        \n        public function filter_variation_prices( $prices_array, $product, $for_display ) {\n            if ( ! $this->is_restricted_user() || empty( $prices_array['price'] ) ) return $prices_array;\n            \n            $physical_term = get_term( MUYU_PHYSICAL_FORMAT_ID, 'pa_formato' );\n            if ( ! $physical_term || is_wp_error( $physical_term ) ) return $prices_array;\n            \n            foreach ( $prices_array['price'] as $variation_id => $amount ) {\n                $format_slug = get_post_meta( $variation_id, 'attribute_pa_formato', true );\n                if ( $format_slug === $physical_term->slug ) {\n                    unset( \n                        $prices_array['price'][ $variation_id ], \n                        $prices_array['regular_price'][ $variation_id ], \n                        $prices_array['sale_price'][ $variation_id ] \n                    );\n                }\n            }\n            return $prices_array;\n        }\n        \n        public function set_format_default( $defaults, $product ) {\n            $is_restricted = $this->is_restricted_user();\n            $country       = $this->get_user_country_code();\n            \n            if ( $is_restricted ) {\n                $term_id = MUYU_DIGITAL_FORMAT_ID;\n            } elseif ( 'AR' === $country ) {\n                $term_id = MUYU_PHYSICAL_FORMAT_ID;\n            } else {\n                return $defaults;\n            }\n            \n            $term = get_term( $term_id, 'pa_formato' );\n            if ( $term && ! is_wp_error( $term ) ) {\n                $defaults['pa_formato'] = $term->slug;\n            }\n            return $defaults;\n        }\n        \n        public function autoselect_format_variation_bridge() {\n            global $product;\n            if ( ! $product || ! $product->is_type( 'variable' ) ) return;\n\n            $is_restricted = $this->is_restricted_user();\n            $country       = $this->get_user_country_code();\n\n            if ( $is_restricted ) {\n                $target_term_id = MUYU_DIGITAL_FORMAT_ID;\n                $hide_row       = true;\n            } elseif ( 'AR' === $country ) {\n                $target_term_id = MUYU_PHYSICAL_FORMAT_ID;\n                $hide_row       = false;\n            } else {\n                return;\n            }\n\n            $attributes = $product->get_variation_attributes();\n            if ( ! isset( $attributes['pa_formato'] ) ) return;\n\n            $target_term = get_term( $target_term_id, 'pa_formato' );\n            if ( ! $target_term || is_wp_error( $target_term ) ) return;\n            if ( ! in_array( $target_term->slug, $attributes['pa_formato'], true ) ) return;\n\n            // Bridge para js/shop.js (Evita <script> inline según MIGRATION-GUIDE.md)\n            printf(\n                '<span id=\"mu-format-autoselect-data\" style=\"display:none\" data-target-slug=\"%s\" data-hide-row=\"%s\"></span>',\n                esc_attr( $target_term->slug ),\n                $hide_row ? 'true' : 'false'\n            );\n        }\n    }\n}\n\n/**\n * ============================================================================\n * INICIALIZACIÓN Y COMPATIBILIDAD\n * ============================================================================\n */\n\nif ( ! function_exists( 'muyu_digital_restriction_init' ) ) {\n    function muyu_digital_restriction_init() {\n        return MUYU_Digital_Restriction_System::get_instance();\n    }\n    // Prioridad temprana para registrar hooks correctamente\n    add_action( 'plugins_loaded', 'muyu_digital_restriction_init', 5 );\n}\n\n/* --- Helpers Funcionales para Backward Compatibility --- */\n\nif ( ! function_exists( 'muyu_is_restricted_user' ) ) {\n    function muyu_is_restricted_user() {\n        return muyu_digital_restriction_init()->is_restricted_user();\n    }\n}\n\nif ( ! function_exists( 'muyu_get_digital_product_ids' ) ) {\n    function muyu_get_digital_product_ids() {\n        return get_option( MUYU_Digital_Restriction_System::OPTION_PRODUCT_IDS, [] );\n    }\n}\n\nif ( ! function_exists( 'muyu_rebuild_digital_indexes_optimized' ) ) {\n    function muyu_rebuild_digital_indexes_optimized() {\n        return muyu_digital_restriction_init()->rebuild_digital_indexes();\n    }\n}\n